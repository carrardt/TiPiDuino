/*

Arduino library v1.0
LCD12864R
www.DFRobot.com
*/
#include "LCD12864.h"

#include <AvrTL/AvrTLPin.h>

#include <avr/pgmspace.h>


static avrtl::StaticPin<17> RS;
static avrtl::StaticPin<16> RW;
static avrtl::StaticPin<18> EN;
static avrtl::StaticPin<8> D0;
static avrtl::StaticPin<9> D1;
static avrtl::StaticPin<10> D2;
static avrtl::StaticPin<11> D3;
static avrtl::StaticPin<4> D4;
static avrtl::StaticPin<5> D5;
static avrtl::StaticPin<6> D6;
static avrtl::StaticPin<7> D7;

/*
static const int RS = 17; 
static const int RW = 16;  
static const int EN = 18;  
static const int D0  = 8;  
static const int D1  = 9; 
static const int D2  = 10;  
static const int D3  = 11;  
static const int D4  = 4; 
static const int D5  = 5;  
static const int D6  = 6;  
static const int D7  = 7; 
*/

#ifndef LCD12864_BUILTIN_FONT
const uint8_t font8x8[64*16] PROGMEM = { 
	 0b00000000, 0b01111110, 0b01111110, 0b01101100, 0b00010000, 0b00111000, 0b00010000, 0b00000000, 0b11111111, 0b00111100, 0b00111100, 0b00001111, 0b00111100, 0b00111111, 0b01111111, 0b10011001
	,0b00000000, 0b10000001, 0b11111111, 0b11111110, 0b00111000, 0b01111100, 0b00010000, 0b00000000, 0b11111111, 0b01000010, 0b01000010, 0b00000111, 0b01100110, 0b00110011, 0b01100011, 0b01011010
	,0b00000000, 0b10100101, 0b11011011, 0b11111110, 0b01111100, 0b00111000, 0b00111000, 0b00011000, 0b11100111, 0b10000001, 0b10011001, 0b00001111, 0b01100110, 0b00111111, 0b01111111, 0b00111100
	,0b00000000, 0b10000001, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b01111100, 0b00111100, 0b11000011, 0b10000001, 0b10111101, 0b01111101, 0b01100110, 0b00110000, 0b01100011, 0b11100111
	,0b00000000, 0b10111101, 0b11000011, 0b01111100, 0b01111100, 0b11111110, 0b11111110, 0b00111100, 0b11000011, 0b10000001, 0b10111101, 0b11001100, 0b00111100, 0b00110000, 0b01100011, 0b11100111
	,0b00000000, 0b10011001, 0b11100111, 0b00111000, 0b00111000, 0b11010110, 0b01111100, 0b00011000, 0b11100111, 0b10000001, 0b10011001, 0b11001100, 0b00011000, 0b01110000, 0b01100111, 0b00111100
	,0b00000000, 0b10000001, 0b11111111, 0b00010000, 0b00010000, 0b00010000, 0b00010000, 0b00000000, 0b11111111, 0b01000010, 0b01000010, 0b11001100, 0b01111110, 0b11110000, 0b11100110, 0b01011010
	,0b00000000, 0b01111110, 0b01111110, 0b00000000, 0b00000000, 0b00111000, 0b00111000, 0b00000000, 0b11111111, 0b00111100, 0b00111100, 0b01111000, 0b00011000, 0b11100000, 0b11000000, 0b10011001
	,0b10000000, 0b00000010, 0b00011000, 0b01100110, 0b01111111, 0b01111110, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b11100000, 0b00001110, 0b00111100, 0b01100110, 0b11011011, 0b11000011, 0b00000000, 0b00111100, 0b00111100, 0b00011000, 0b00011000, 0b00110000, 0b00000000, 0b00100100, 0b00011000, 0b11111111
	,0b11111000, 0b00111110, 0b01111110, 0b01100110, 0b11011011, 0b01111000, 0b00000000, 0b01111110, 0b01111110, 0b00011000, 0b00001100, 0b01100000, 0b11000000, 0b01100110, 0b00111100, 0b11111111
	,0b11111110, 0b11111110, 0b00011000, 0b01100110, 0b01111011, 0b11001100, 0b00000000, 0b00011000, 0b00011000, 0b00011000, 0b11111110, 0b11111110, 0b11000000, 0b11111111, 0b01111110, 0b01111110
	,0b11111000, 0b00111110, 0b00011000, 0b01100110, 0b00011011, 0b11001100, 0b01111110, 0b01111110, 0b00011000, 0b01111110, 0b00001100, 0b01100000, 0b11000000, 0b01100110, 0b11111111, 0b00111100
	,0b11100000, 0b00001110, 0b01111110, 0b00000000, 0b00011011, 0b01111000, 0b01111110, 0b00111100, 0b00011000, 0b00111100, 0b00011000, 0b00110000, 0b11111110, 0b00100100, 0b11111111, 0b00011000
	,0b10000000, 0b00000010, 0b00111100, 0b01100110, 0b00011011, 0b10001100, 0b01111110, 0b00011000, 0b00011000, 0b00011000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b00000000, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b11111000, 0b00000000, 0b11111111, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b00000000, 0b01111000, 0b01101100, 0b01101100, 0b00110000, 0b00000000, 0b00111000, 0b01100000, 0b00011000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000110
	,0b00000000, 0b01111000, 0b01101100, 0b01101100, 0b11111100, 0b11000110, 0b01101100, 0b01100000, 0b00110000, 0b00110000, 0b01100110, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00001100
	,0b00000000, 0b01111000, 0b01101100, 0b11111110, 0b11000000, 0b11001100, 0b00111000, 0b11000000, 0b01100000, 0b00011000, 0b00111100, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00011000
	,0b00000000, 0b01111000, 0b00000000, 0b01101100, 0b11111100, 0b00011000, 0b01110110, 0b00000000, 0b01100000, 0b00011000, 0b11111111, 0b11111100, 0b00000000, 0b11111100, 0b00000000, 0b00110000
	,0b00000000, 0b00110000, 0b00000000, 0b11111110, 0b00001100, 0b00110000, 0b11011100, 0b00000000, 0b01100000, 0b00011000, 0b00111100, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b01100000
	,0b00000000, 0b00000000, 0b00000000, 0b01101100, 0b11111100, 0b01100110, 0b11001100, 0b00000000, 0b00110000, 0b00110000, 0b01100110, 0b00110000, 0b01110000, 0b00000000, 0b00110000, 0b11000000
	,0b00000000, 0b00110000, 0b00000000, 0b01101100, 0b00110000, 0b11000110, 0b01110110, 0b00000000, 0b00011000, 0b01100000, 0b00000000, 0b00000000, 0b00110000, 0b00000000, 0b00110000, 0b10000000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01100000, 0b00000000, 0b00000000, 0b00000000
	,0b01111000, 0b00110000, 0b01111000, 0b01111000, 0b00011100, 0b11111100, 0b00111000, 0b11111100, 0b01111000, 0b01111000, 0b00000000, 0b00000000, 0b00011000, 0b00000000, 0b01100000, 0b01111000
	,0b11001100, 0b11110000, 0b11001100, 0b11001100, 0b00111100, 0b11000000, 0b01100000, 0b11001100, 0b11001100, 0b11001100, 0b00000000, 0b00000000, 0b00110000, 0b00000000, 0b00110000, 0b11001100
	,0b11011100, 0b00110000, 0b00001100, 0b00001100, 0b01101100, 0b11111000, 0b11000000, 0b00001100, 0b11001100, 0b11001100, 0b00110000, 0b00110000, 0b01100000, 0b11111100, 0b00011000, 0b00001100
	,0b11111100, 0b00110000, 0b00111000, 0b00111000, 0b11001100, 0b00001100, 0b11111000, 0b00011000, 0b01111000, 0b01111100, 0b00110000, 0b00110000, 0b11000000, 0b00000000, 0b00001100, 0b00011000
	,0b11101100, 0b00110000, 0b01100000, 0b00001100, 0b11111110, 0b00001100, 0b11001100, 0b00110000, 0b11001100, 0b00001100, 0b00000000, 0b00000000, 0b01100000, 0b11111100, 0b00011000, 0b00110000
	,0b11001100, 0b00110000, 0b11001100, 0b11001100, 0b00001100, 0b11001100, 0b11001100, 0b01100000, 0b11001100, 0b00011000, 0b00110000, 0b01110000, 0b00110000, 0b00000000, 0b00110000, 0b00000000
	,0b01111000, 0b11111100, 0b11111100, 0b01111000, 0b00001100, 0b01111000, 0b01111000, 0b01100000, 0b01111000, 0b01110000, 0b00110000, 0b00110000, 0b00011000, 0b00000000, 0b01100000, 0b00110000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b01111100, 0b00110000, 0b11111100, 0b00111100, 0b11111100, 0b11111110, 0b11111110, 0b00111100, 0b11001100, 0b01111000, 0b00011110, 0b11100110, 0b11110000, 0b11000110, 0b11000110, 0b00111000
	,0b11000110, 0b01111000, 0b01100110, 0b01100110, 0b01101100, 0b01100010, 0b01100010, 0b01100110, 0b11001100, 0b00110000, 0b00001100, 0b01100110, 0b01100000, 0b11101110, 0b11100110, 0b01101100
	,0b11011110, 0b11001100, 0b01100110, 0b11000000, 0b01100110, 0b01101000, 0b01101000, 0b11000000, 0b11001100, 0b00110000, 0b00001100, 0b01101100, 0b01100000, 0b11111110, 0b11110110, 0b11000110
	,0b11011110, 0b11001100, 0b01111100, 0b11000000, 0b01100110, 0b01111000, 0b01111000, 0b11000000, 0b11111100, 0b00110000, 0b00001100, 0b01111000, 0b01100000, 0b11010110, 0b11011110, 0b11000110
	,0b11011110, 0b11111100, 0b01100110, 0b11000000, 0b01100110, 0b01101000, 0b01101000, 0b11001110, 0b11001100, 0b00110000, 0b11001100, 0b01101100, 0b01100010, 0b11000110, 0b11001110, 0b11000110
	,0b11000000, 0b11001100, 0b01100110, 0b01100110, 0b01101100, 0b01100010, 0b01100000, 0b01100110, 0b11001100, 0b00110000, 0b11001100, 0b01100110, 0b01100110, 0b11000110, 0b11000110, 0b01101100
	,0b01111000, 0b11001100, 0b11111100, 0b00111100, 0b11111100, 0b11111110, 0b11110000, 0b00111110, 0b11001100, 0b01111000, 0b01111000, 0b11100110, 0b11111110, 0b11000110, 0b11000110, 0b00111000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b11111100, 0b01111000, 0b11111100, 0b01111000, 0b11111100, 0b11001100, 0b11001100, 0b11000110, 0b11000110, 0b11001100, 0b11111110, 0b01111000, 0b11000000, 0b01111000, 0b00010000, 0b00000000
	,0b01100110, 0b11001100, 0b01100110, 0b11001100, 0b10110100, 0b11001100, 0b11001100, 0b11000110, 0b11000110, 0b11001100, 0b11001100, 0b01100000, 0b01100000, 0b00011000, 0b00111000, 0b00000000
	,0b01100110, 0b11001100, 0b01100110, 0b11100000, 0b00110000, 0b11001100, 0b11001100, 0b11000110, 0b01101100, 0b11001100, 0b10011000, 0b01100000, 0b00110000, 0b00011000, 0b01101100, 0b00000000
	,0b01111100, 0b11001100, 0b01111100, 0b00111000, 0b00110000, 0b11001100, 0b11001100, 0b11010110, 0b00111000, 0b01111000, 0b00110000, 0b01100000, 0b00011000, 0b00011000, 0b11000110, 0b00000000
	,0b01100000, 0b11011100, 0b01111000, 0b00011100, 0b00110000, 0b11001100, 0b11001100, 0b11111110, 0b01101100, 0b00110000, 0b01100010, 0b01100000, 0b00001100, 0b00011000, 0b00000000, 0b00000000
	,0b01100000, 0b01111000, 0b01101100, 0b11001100, 0b00110000, 0b11001100, 0b01111000, 0b11101110, 0b11000110, 0b00110000, 0b11000110, 0b01100000, 0b00000110, 0b00011000, 0b00000000, 0b00000000
	,0b11110000, 0b00011100, 0b11100110, 0b01111000, 0b01111000, 0b11111100, 0b00110000, 0b11000110, 0b11000110, 0b01111000, 0b11111110, 0b01111000, 0b00000010, 0b01111000, 0b00000000, 0b00000000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111111
	,0b00110000, 0b00000000, 0b11100000, 0b00000000, 0b00011100, 0b00000000, 0b00111000, 0b00000000, 0b11100000, 0b00110000, 0b00011000, 0b11100000, 0b01110000, 0b00000000, 0b00000000, 0b00000000
	,0b00110000, 0b00000000, 0b01100000, 0b00000000, 0b00001100, 0b00000000, 0b01101100, 0b00000000, 0b01100000, 0b00000000, 0b00000000, 0b01100000, 0b00110000, 0b00000000, 0b00000000, 0b00000000
	,0b00011000, 0b01111000, 0b01111100, 0b01111000, 0b00001100, 0b01111000, 0b01100000, 0b01110110, 0b01101100, 0b01110000, 0b01111000, 0b01100110, 0b00110000, 0b11101100, 0b11111000, 0b01111000
	,0b00000000, 0b00001100, 0b01100110, 0b11001100, 0b01111100, 0b11001100, 0b11110000, 0b11001100, 0b01110110, 0b00110000, 0b00011000, 0b01101100, 0b00110000, 0b11111110, 0b11001100, 0b11001100
	,0b00000000, 0b01111100, 0b01100110, 0b11000000, 0b11001100, 0b11111100, 0b01100000, 0b11001100, 0b01100110, 0b00110000, 0b00011000, 0b01111000, 0b00110000, 0b11010110, 0b11001100, 0b11001100
	,0b00000000, 0b11001100, 0b01100110, 0b11001100, 0b11001100, 0b11000000, 0b01100000, 0b01111100, 0b01100110, 0b00110000, 0b00011000, 0b01101100, 0b00110000, 0b11000110, 0b11001100, 0b11001100
	,0b00000000, 0b01110110, 0b10111100, 0b01111000, 0b01110110, 0b01111000, 0b11110000, 0b00001100, 0b11100110, 0b01111000, 0b11011000, 0b11100110, 0b01111000, 0b11000110, 0b11001100, 0b01111000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111000, 0b00000000, 0b00000000, 0b01110000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00010000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00011100, 0b00011000, 0b11100000, 0b01110110, 0b00010000
	,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00110000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00110000, 0b00011000, 0b00110000, 0b11011100, 0b00111000
	,0b11011100, 0b01110110, 0b11011000, 0b01111100, 0b01111100, 0b11001100, 0b11001100, 0b11000110, 0b11000110, 0b11001100, 0b11111100, 0b00110000, 0b00011000, 0b00110000, 0b00000000, 0b01101100
	,0b01100110, 0b11001100, 0b01101100, 0b11000000, 0b00110000, 0b11001100, 0b11001100, 0b11000110, 0b01101100, 0b11001100, 0b10011000, 0b11100000, 0b00000000, 0b00011100, 0b00000000, 0b11000110
	,0b01100110, 0b11001100, 0b01101100, 0b01111000, 0b00110000, 0b11001100, 0b11001100, 0b11010110, 0b00111000, 0b11001100, 0b00110000, 0b00110000, 0b00011000, 0b00110000, 0b00000000, 0b11000110
	,0b01111100, 0b01111100, 0b01100000, 0b00001100, 0b00110100, 0b11001100, 0b01111000, 0b11111110, 0b01101100, 0b01111100, 0b01100100, 0b00110000, 0b00011000, 0b00110000, 0b00000000, 0b11000110
	,0b01100000, 0b00001100, 0b11110000, 0b11111000, 0b00011000, 0b01110110, 0b00110000, 0b01101100, 0b11000110, 0b00001100, 0b11111100, 0b00011100, 0b00011000, 0b11100000, 0b00000000, 0b11111110
	,0b11110000, 0b00011110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
};
#endif

LCD12864::LCD12864() 
{
} 

void LCD12864::render()
{
	//Clear();
#ifdef LCD12864_BUILTIN_FONT
	for(uint8_t y=0;y<rows;y++)
	{
		DisplayString(y,0,this->TextFrameBuffer::m_buffer[y],cols);
	}
#else
	RenderText8x8();
#endif
}

void LCD12864::setPins(bool tRS, bool tRW, uint8_t vector) 
{
	RS = tRS;
	RW = tRW;
	D0 = vector&1 ; vector=vector>>1;
	D1 = vector&1 ; vector=vector>>1;
	D2 = vector&1 ; vector=vector>>1;
	D3 = vector&1 ; vector=vector>>1;
	D4 = vector&1 ; vector=vector>>1;
	D5 = vector&1 ; vector=vector>>1;
	D6 = vector&1 ; vector=vector>>1;
	D7 = vector&1 ;

	EN = HIGH;
	delayns();
	EN = LOW;
	delayns();
}

//*********************延时函数************************//
void LCD12864::delayns()
{  
	avrtl::delayMicroseconds(DelayTime);
}

void LCD12864::WriteCommand(uint8_t CMD)
{ 
   delayns();
   delayns();
   setPins(0,0,CMD); //WriteCommand

}
void LCD12864::WriteData(uint8_t CMD)
{  
   delayns();
   delayns();
   setPins(1,0,CMD); //WriteData
}

void LCD12864::Initialise() 
{
	RS.SetOutput();
	RW.SetOutput();
	EN.SetOutput();
	D0.SetOutput();
	D1.SetOutput();
	D2.SetOutput();
	D3.SetOutput();
	D4.SetOutput();
	D5.SetOutput();
	D6.SetOutput();
	D7.SetOutput();

	delayns();
	WriteCommand(0x30);        //功能设定控制字
	WriteCommand(0x0c);        //显示开关控制字
	WriteCommand(0x01);        //清除屏幕控制字
	WriteCommand(0x06);        //进入设定点控制字
}
void LCD12864::Clear()
{  
    WriteCommand(0x30);//
    WriteCommand(0x01);//清除显示
}
void LCD12864::DisplayString(int X,int Y,uint8_t *ptr,int dat)
{
  int i;
  switch(X)
   {
     case 0:  Y|=0x80;break;

     case 1:  Y|=0x90;break;

     case 2:  Y|=0x88;break;

     case 3:  Y|=0x98;break;

     default: break;
   }
  WriteCommand(Y);// 定位显示起始地址
  for(i=0;i<dat;i++)
    { 
      WriteData(ptr[i]);//显示汉字时注意码值，连续两个码表示一个汉字
    }
}

#ifndef LCD12864_BUILTIN_FONT
void LCD12864::RenderText8x8()
{
	int ygroup,x,y,i;
	int temp;
	int tmp;

	for(ygroup=0;ygroup<64;ygroup++) //写入液晶上半图象部分
	{                           //写入坐标
		if(ygroup<32)
		{
			x=0x80;
			y=ygroup+0x80;
		}
		else 
		{
			x=0x88;
			y=ygroup-32+0x80;    
		}         
		WriteCommand(0x34);        //写入扩充指令命令
		WriteCommand(y);           //写入y轴坐标
		WriteCommand(x);           //写入x轴坐标
		WriteCommand(0x30);        //写入基本指令命令
		WriteCommand(0x0c);
		tmp=ygroup*16;
		for(i=0;i<16;i++)
		{
			int j = ygroup/8;
			int c = this->TextFrameBuffer::m_buffer[j][i];
			if( c<0 || c>=128 ) c = ' ';
			int caddr = ( (c/16)*8 + (ygroup%8) )*16 + (c%16);
			temp = pgm_read_byte_near( font8x8 + caddr );
			WriteData(temp);
		}
	}
	WriteCommand(0x34);        //写入扩充指令命令
	WriteCommand(0x36);        //显示图象
}
#endif

void LCD12864::DrawFullScreen(uint8_t *p)
{
	int ygroup,x,y,i;
	int temp;
	int tmp;

	for(ygroup=0;ygroup<64;ygroup++) //写入液晶上半图象部分
	{                           //写入坐标
		if(ygroup<32)
		{
			x=0x80;
			y=ygroup+0x80;
		}
		else 
		{
			x=0x88;
			y=ygroup-32+0x80;    
		}         
		WriteCommand(0x34);        //写入扩充指令命令
		WriteCommand(y);           //写入y轴坐标
		WriteCommand(x);           //写入x轴坐标
		WriteCommand(0x30);        //写入基本指令命令
		WriteCommand(0x0c);
		tmp=ygroup*16;
		for(i=0;i<16;i++)
		{
			temp=p[tmp++];
			WriteData(temp);
		}
	}
	WriteCommand(0x34);        //写入扩充指令命令
	WriteCommand(0x36);        //显示图象
}
